# Copilot Instructions

- Stack: React 19 + TypeScript with Vite; Tailwind 4; Framer Motion; Supabase via supabase-js; Chart.js through react-chartjs-2; XLSX for exports.
- Entry/layout: [src/App.tsx](src/App.tsx) wires BrowserRouter + ProtectedRoute, lazy-loads page components, renders Sidebar/ProfileHeader shell, and runs AutoLogout (30-minute inactivity â†’ signOut + alert).
- Data layer: [src/context/DataContext.tsx](src/context/DataContext.tsx) is the single source for session, CRUD, caching, and scoping; uses paginated fetchAllRecords (1000 rows) and localStorage caches (keys prefixed `loan_app_cache_`). Prefer calling context methods instead of direct Supabase queries.
- Scoping rules: scoped users are detected by matching auth user_id to customers; when scoped, all fetches filter by customer_id and most mutations throw read-only errors. Admin-only routes are enforced by AdminOnlyRoute in [src/App.tsx](src/App.tsx) and nav filtering in [src/components/Sidebar.tsx](src/components/Sidebar.tsx). Scoped users may only edit their own station_name via updateCustomer.
- Auth/session: DataProvider initializes supabase auth session, caches data for fast rehydrate, and listens to auth changes; signOut clears caches. AutoLogout runs globally, and ProtectedRoute guards all non-/login routes.
- Background user provisioning: addCustomer inserts the customer then POSTs `/.netlify/functions/create-user-from-customer` ([netlify/functions/create-user-from-customer.js](netlify/functions/create-user-from-customer.js)), which uses the service role key to create a Supabase auth user (`{phone}@gmail.com` / `{phone}`) and update customer.user_id. Failures are logged but do not block the add flow; events dispatched on `window` under `background-user-create`.
- Deletion flow: deleteCustomer cascades Supabase deletes for data_entries, installments, loans, subscriptions, and calls `/.netlify/functions/delete-user-from-customer` to remove the linked auth user when present.
- Seniority list: accessible to all users; scoped customers can add their own entry (with system_notifications) but cannot update/delete. Admins can add/update/delete via DataContext functions.
- Routes/pages: home renders CustomerDashboard for scoped users, AddCustomerPage (admin-only) otherwise. Other routes: /login, /add-record, /customers, /customers/:id, /loans, /loan-seniority, /loans/:id, /subscriptions, /summary, /data. Pages live in [src/components/pages](src/components/pages) and are lazy-loaded.
- UI/shared patterns: common UI components in [src/components/ui](src/components/ui) (glassmorphism styling), modals in [src/components/modals](src/components/modals); formatting helpers in [src/utils/dateFormatter.ts](src/utils/dateFormatter.ts) and [src/utils/numberFormatter.ts](src/utils/numberFormatter.ts); hook utilities in [src/components/hooks/useFocusTrap.tsx](src/components/hooks/useFocusTrap.tsx) and [src/utils/useDebounce.ts](src/utils/useDebounce.ts).
- Build/run: `npm run dev` (vite), `npm run build`, `npm run preview`. Scripts requiring Supabase service role env vars: `npm run create-users`, `npm run verify-users`, `npm run reset-password`, `npm run setup-env`.
- Environment: frontend uses Supabase anon URL/key (see [src/lib/supabase.ts](src/lib/supabase.ts)); never expose `SUPABASE_SERVICE_ROLE_KEY` in client code. Netlify functions/scripts expect `SUPABASE_SERVICE_ROLE_KEY`, `SUPABASE_URL`, `SUPABASE_ANON_KEY`, `SUPABASE_AUTH_URL` set server-side.
- Deployment: Netlify build command is `npm run build`; serverless functions deploy from [netlify/functions](netlify/functions). Avoid committing secrets; rely on Netlify environment settings.
